<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://alhatorah.org/Home/ref.php"></script>
    <style>
      .autocomplete-active {
        background-color: pink;
      }
    </style>
  </head>
  <body>
    <form method="get" autocomplete="off" action="">
      <label for="search-input">הכנס מילות חיפוש או ספר ופרק: </label>
      <input placeholder="בחרו טקסט או חפשו מלים" id="search-input" />
    </form>

    <script>
      document.getElementById("search-input").focus();

      let currentFocus;

      function closeAllLists(element) {
        $(".autocomplete-dropdown").not(element).remove();
        currentFocus = -1;
      }
      function handleClick(params) {
        var input = params.input;
        closeAllLists();
        if (params.item.getAttribute("data-value"))
          input.value = params.item.getAttribute("data-value");
        else {
          aht.texts.textOrSearch.search(input.value);
          return false;
        }
        aht.texts.textOrSearch.go(input);
      }
      function buildDropdown(input, suggestions) {
        var dropdown,
          items,
          line,
          i,
          windowHeight,
          $input = $(input);
        currentFocus = -1;
        dropdown = document.createElement("DIV");
        dropdown.setAttribute("class", "autocomplete-dropdown");
        input.parentNode.appendChild(dropdown);
        line = document.createElement("DIV");
        line.setAttribute("class", "autocomplete-item");
        line.innerHTML =
          '<span>חפש</span>: "<strong>' + input.value + '</strong>"';
        dropdown.appendChild(line);
        items = document.createElement("DIV");
        items.setAttribute("id", input.id + "autocomplete-list");
        items.setAttribute("class", "autocomplete-items");
        dropdown.appendChild(items);
        for (i = 0; i < suggestions.length; i++) {
          line = document.createElement("DIV");
          line.setAttribute("class", "autocomplete-item");
          line.setAttribute("data-value", suggestions[i].value);
          line.innerHTML = suggestions[i].text;
          items.appendChild(line);
        }
        $(dropdown).on("click", ".autocomplete-item", function (e) {
          handleClick({
            item: this,
            input: input,
          });
          return false;
        });
      }
      function autocomplete(input, getSuggestions) {
        $(input).on("input", function (e) {
          closeAllLists();
          if (!this.value) return false;
          getSuggestions(input, function (suggestions) {
            closeAllLists();
            buildDropdown(input, suggestions);
          });
        });
        addActive(document.getElementById(this.id + "autocomplete-list"), 0);
        input.addEventListener("keydown", function (e) {
          var x = document.getElementById(this.id + "autocomplete-list");
          if (x) x = x.getElementsByTagName("div");
          if (e.keyCode == 40) {
            currentFocus++;
            addActive(x, 1);
          } else if (e.keyCode == 38) {
            currentFocus--;
            addActive(x, -1);
          } else if (e.keyCode == 13) {
            if (currentFocus > -1) {
              e.preventDefault();
              if (x) x[currentFocus].click();
            }
          }
        });
        function addActive(x, dir) {
          if (!x) return false;
          removeActive(x);
          if (currentFocus >= x.length) {
            currentFocus = 0;
            dir = -1;
          }
          if (currentFocus < 0) {
            currentFocus = x.length - 1;
            dir = 1;
          }
          x[currentFocus].classList.add("autocomplete-active");
          var $list = $(".autocomplete-items");
          (scrollTop = $list.scrollTop()),
            (itemTop = x[currentFocus].offsetTop);
          if (dir == 1) {
            var itemHeight = $(x[currentFocus]).outerHeight(true),
              listHeight = $list.height();
            if (itemTop + itemHeight > listHeight - scrollTop)
              $list.scrollTop(itemTop + itemHeight - listHeight);
          } else if (itemTop < scrollTop) $list.scrollTop(itemTop);
        }
        function removeActive(x) {
          for (var i = 0; i < x.length; i++)
            x[i].classList.remove("autocomplete-active");
        }
        document.addEventListener("click", function (e) {
          closeAllLists(e.target);
        });
      }
      aht.texts.init(function () {}, {
        tree: false,
      });
      function callGetSuggestions(input, response) {
        var value = input.value,
          $form = $(input).closest("form"),
          lang = "he";
        aht.texts.textOrSearch.getSuggestions(
          {
            term: value,
          },
          response,
          "he"
        );
      }
      autocomplete(document.getElementById("search-input"), callGetSuggestions);
    </script>
  </body>
</html>
