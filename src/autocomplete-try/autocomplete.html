<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://alhatorah.org/Home/ref.php"></script>
    <style>
      .autocomplete-active {
        background-color: pink;
      }
    </style>
  </head>
  <body>
    <form method="get" autocomplete="off" action="">
      <label for="search-input">הכנס מילות חיפוש או ספר ופרק: </label>
      <input placeholder="בחרו טקסט או חפשו מלים" id="search-input" />
    </form>

    <script>
      document.getElementById("search-input").focus();

      let autocompleteData = {
        maxLines: 50,
        closeAllLists: function (elmnt) {
          $(".autocomplete-dropdown").not(elmnt).remove();
          this.currentFocus = -1;
        },
      };
      autocompleteData.handleClick = function (params) {
        var input = params.input,
          $form = $(input).closest("form"),
          isTopicNameInput = $form.hasClass("topic-input-form"),
          search = false;
        let handlingClick = Date.now();
        this.closeAllLists();
        if (params.item.getAttribute("data-value"))
          input.value = params.item.getAttribute("data-value");
        else {
          if (isTopicNameInput) search = true;
          else {
            aht.texts.textOrSearch.search(input.value);
            return false;
          }
        }
        if (isTopicNameInput) {
          var $fullText = $form.find(".possible-fulltext");
          if (search) $fullText.attr("name", "fulltext");
          $form.submit();
          if (search) $fullText.removeAttr("name");
        } else aht.texts.textOrSearch.go(input);
      };
      autocompleteData.buildDropdown = function (input, suggestions) {
        var dropdown,
          items,
          line,
          i,
          windowHeight,
          $input = $(input);
        autocompleteData.currentFocus = -1;
        dropdown = document.createElement("DIV");
        dropdown.setAttribute("class", "autocomplete-dropdown");
        input.parentNode.appendChild(dropdown);
        line = document.createElement("DIV");
        line.setAttribute("class", "autocomplete-item");
        line.innerHTML =
          '<span>חפש</span>: "<strong>' + input.value + '</strong>"';
        dropdown.appendChild(line);
        items = document.createElement("DIV");
        items.setAttribute("id", input.id + "autocomplete-list");
        items.setAttribute("class", "autocomplete-items");
        if (window.ios)
          windowHeight =
            (window.innerHeight > window.innerWidth ? 0.67 : 0.4) *
            window.innerHeight;
        else windowHeight = window.innerHeight;
        items.setAttribute(
          "style",
          "max-height: " +
            (windowHeight - $(line).outerHeight() - $(line).offset().top) +
            "px"
        );
        dropdown.appendChild(items);
        for (i = 0; i < suggestions.length; i++) {
          line = document.createElement("DIV");
          line.setAttribute("class", "autocomplete-item");
          line.setAttribute("data-value", suggestions[i].value);
          line.innerHTML = suggestions[i].text;
          items.appendChild(line);
        }
        $(dropdown).on("click", ".autocomplete-item", function (e) {
          autocompleteData.handleClick({
            item: this,
            input: input,
          });
          return false;
        });
      };
      function autocomplete(input, getSuggestions) {
        $(input).on("input", function (e) {
          autocompleteData.closeAllLists();
          if (!this.value) return false;
          getSuggestions(input, function (suggestions) {
            autocompleteData.closeAllLists();
            autocompleteData.buildDropdown(input, suggestions);
          });
        });
        input.addEventListener("keydown", function (e) {
          console.log(e);
          var x = document.getElementById(this.id + "autocomplete-list");
          if (x) x = x.getElementsByTagName("div");
          if (e.keyCode == 40) {
            autocompleteData.currentFocus++;
            addActive(x, 1);
          } else if (e.keyCode == 38) {
            autocompleteData.currentFocus--;
            addActive(x, -1);
          } else if (e.keyCode == 13) {
            if (autocompleteData.currentFocus > -1) {
              e.preventDefault();
              if (x) x[autocompleteData.currentFocus].click();
            }
          }
        });
        function addActive(x, dir) {
          if (!x) return false;
          removeActive(x);
          if (autocompleteData.currentFocus >= x.length) {
            autocompleteData.currentFocus = 0;
            dir = -1;
          }
          if (autocompleteData.currentFocus < 0) {
            autocompleteData.currentFocus = x.length - 1;
            dir = 1;
          }
          x[autocompleteData.currentFocus].classList.add("autocomplete-active");
          var $list = $(".autocomplete-items");
          (scrollTop = $list.scrollTop()),
            (itemTop = x[autocompleteData.currentFocus].offsetTop);
          if (dir == 1) {
            var itemHeight = $(x[autocompleteData.currentFocus]).outerHeight(
                true
              ),
              listHeight = $list.height();
            if (itemTop + itemHeight > listHeight - scrollTop)
              $list.scrollTop(itemTop + itemHeight - listHeight);
          } else if (itemTop < scrollTop) $list.scrollTop(itemTop);
        }
        function removeActive(x) {
          for (var i = 0; i < x.length; i++)
            x[i].classList.remove("autocomplete-active");
        }
        document.addEventListener("click", function (e) {
          autocompleteData.closeAllLists(e.target);
        });
      }
      aht.texts.init(function () {}, {
        tree: false,
      });
      function callGetSuggestions(input, response) {
        var value = input.value,
          $form = $(input).closest("form"),
          lang = "he";
        aht.texts.textOrSearch.getSuggestions(
          {
            term: value,
          },
          response,
          "he"
        );
      }
      autocomplete(document.getElementById("search-input"), callGetSuggestions);
    </script>
  </body>
</html>
